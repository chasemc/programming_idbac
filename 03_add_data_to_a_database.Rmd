# Add Data to an IDBac Database


So, we've already seen how to connect to an existing IDBac database, and what an IDBac database consists of. In this section we'll learn how to add our own data to a new, or exisisting, IDBac database.

```{r}
library(dplyr)
```


```{r}
library(here)
```



## Make a new empty IDBac database

```{r include=FALSE}

mzxml_dir <- here::here("data", "mzxml")
dir.create(mzxml_dir)

mzxml_files <- c("172-1.mzXML",
                 "172-7.mzXML",
                 "172-10.mzXML",
                 "172-11.mzXML",
                 "Matrix.mzXML")

if (any(!file.exists(here::here('data', 'mzxml', mzxml_files)))) { #cache  mzxml fetch
  
  for (i in mzxml_files) {
    download.file(url = paste0("ftp://massive.ucsd.edu/MSV000084291/raw/data/mzXML/", i),
                  destfile = here::here("data", "mzxml", i),
                  mode = "wb")
  }
}


```


We have five mzXML files in folder: `~data/mzxml`

```{r}
list.files(here::here("data", "mzxml"))
```



Create a new, empty, database named `my_new_database` in `~data/databases`
```{r message=FALSE, warning=FALSE}

IDBacApp::idbac_create(fileName = "my_new_database",
                       filePath = here::here("data",
                                             "databases"))

```

Connect to the new database
```{r}
db_connection <- IDBacApp::idbac_connect(fileName = "my_new_database",
                                         filePath = here::here("data",
                                                               "databases"))
```


It is indeed empty:

```{r}
dplyr::tbl(db_connection$my_new_database,
           "spectra")


```



## Add data from an mzXML file


First let's add just a single xml file




```{r}
mz_file_paths <- IDBacApp::find_mz_files(path = here::here("data", "mzxml"),
                                         recursive = FALSE,
                                         full = TRUE)
# only use one
mz_file_paths <- mz_file_paths[[1]]

print(mz_file_paths)
```

Get the name:
```{r}
mz_file_name <- base::basename(tools::file_path_sans_ext(mz_file_paths))

print(mz_file_name)

```


```{r}

mz_file_name <- base::basename(tools::file_path_sans_ext(mz_file_paths))



IDBacApp::process_mzml(mzFilePaths = here::here("data", "mzxml", paste0(mz_file_name, ".mzXML")),
                       sampleIds = mz_file_name,
                       idbacPool = db_connection$my_new_database,
                       acquisitionInfo = NULL)

```


Looking at what is contained within the database we see that four spectra were added to the table `spectra`.

```{r}
dplyr::tbl(db_connection$my_new_database, "spectra")
```

One row was added in the table `metadata`.
```{r}
dplyr::tbl(db_connection$my_new_database, "metadata")
```

Two rows were added in the table `mass_index` (one for the reflectron spectra and one for the protein spectra).

```{r}
dplyr::tbl(db_connection$my_new_database, "mass_index")
```

One row was added in the table `xml`. This contains the original mzXML file.
```{r}
dplyr::tbl(db_connection$my_new_database, "xml")
```



## Adding multiple mzXML files

It is also possible to add multiple mzXML/mzML files at once, simply pass multiple paths and names as character vectors to `IDBacApp::process_mzml()`. 

```{r}
mz_file_paths <- IDBacApp::find_mz_files(path = here::here("data", "mzxml"),
                                         recursive = FALSE,
                                         full = TRUE)
print(mz_file_paths)
```

Names we will use:
```{r}
mz_file_names <- base::basename(tools::file_path_sans_ext(mz_file_paths))

print(mz_file_names)

```


```{r}
IDBacApp::process_mzml(mzFilePaths = mz_file_paths,
                       sampleIds = mz_file_names,
                       idbacPool = db_connection$my_new_database,
                       acquisitionInfo = NULL)

```


We can see below that this has now added data for all of the mzXML files given.  

Important things to note:

1. The data from `172-1` was only added the first time. IDBac only appends data, it *never* overwrites data in the database (except in the metadata table). IDBac looks at each spectrum_mass_hash, spectrum_intensity_hash, and strain_id and only creates a new entry if those are unique from something already existing in the database.

```{r}
dplyr::tbl(db_connection$my_new_database,
           "spectra")
```


The `mass-index` table remains the same because in this case all the data had the same mass values across all protein and small molecule spectra.

```{r}
dplyr::tbl(db_connection$my_new_database,
           "mass_index")
```